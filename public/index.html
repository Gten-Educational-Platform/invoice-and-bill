<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>INVOICE/MONEY RECEIPT</title>
<style>
body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
.container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 10px; }
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.header img { max-height: 60px; }
.header .info { text-align: right; }
h2 { text-align: center; margin-bottom: 10px; }
.form-row { display: flex; gap: 15px; margin-bottom: 10px; }
.form-row input, .form-row select { flex: 1; padding: 6px; font-size: 12px; }
label { font-weight: bold; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
th.small-cell, td.small-cell { width: 60px; }
.actions { margin-top: 15px; display: flex; justify-content: space-between; }
.totals { margin-top: 20px; text-align: right; }
.totals div { margin: 5px 0; }
#dueBalance { font-weight: bold; }
#studentName { font-weight: bold; }
.qr { text-align: center; margin-top: 20px; }
.no-print { display: inline-block; }
input[disabled] { background: #f0f0f0; color: #666; }

td .qty-input, td .rate-input { width: 60px; }
td .total-input { width: 80px; box-sizing: border-box; padding: 0; margin: 0; text-align: right; border: none; background: transparent; font: inherit; font-size: 12px; }
.delete-btn { background: none; border: none; color: #d33; font-size: 16px; cursor: pointer; padding: 0; margin: 0; line-height: 1; }

@media print {
  .no-print { display: none !important; }
  select, input { font-size: 10px; padding: 0; border: none; appearance: none; background: none; color: black; }
}
</style>
</head>
<body>
<div class="container">
<div id="passwordScreen" style="text-align: center; margin-top: 100px;">
<h2>Please enter password to access the invoice</h2>
<input type="password" id="passwordInput" placeholder="Enter password" style="padding: 8px; font-size: 12px;">
<button onclick="checkPassword()" style="padding: 8px 16px; font-size: 12px;">Submit</button>
</div>

<div id="protectedContent" style="display:none;">
<div class="header">
<img src="https://i.ibb.co/WNZTWPwv/LOGO-PNG-2025-fab.png" alt="Logo">
<div class="info">
<div><strong>G10 EDUCATIONAL PLATFORM </strong></div>
<div>Jayanagar Charali, Beltola Bazar Road, Guwahati-28, Ph. No.: 9706380357</div>
<div>Date: <input type="date" id="invoiceDateInput" /></div>
<div>Invoice No: <span id="invoiceNo">-</span></div>
</div>
</div>

<h2>INVOICE/MONEY RECEIPT</h2>

<div class="form-row">
<select id="studentSelect" onchange="handleStudentChange()">
<option value="">-- STUDENT NAME --</option>
</select>
<input list="invoiceList" id="invoiceSelect" placeholder="-- Load Invoice No. --" oninput="handleInvoiceInput()"/>
<datalist id="invoiceList"></datalist>
</div>

<div class="form-row">
<input type="text" id="studentName" placeholder="Student Name" />
<input type="text" id="phone" placeholder="Phone Number" />
</div>
<div class="form-row">
<input type="email" id="email" placeholder="Email ID" />
<input type="text" id="address" placeholder="Address" />
</div>
<div class="form-row">
<select id="studentClass">
<option>Class 8</option>
<option>Class 9</option>
<option>Class 10</option>
<option>Class 11</option>
<option>Class 12</option>
<option>IIT-JEE</option>
<option>NEET</option>
<option>CUET</option>
</select>
</div>

<table class="invoice-table" id="invoiceTable" style="display: none;">
<thead>
<tr>
<th colspan="2">Date</th>
<th rowspan="2">Service Type</th>
<th rowspan="2">Subject</th>
<th rowspan="2" class="small-cell">No's/Qnty</th>
<th rowspan="2" class="small-cell">Rate</th>
<th rowspan="2">Total</th>
<th rowspan="2" class="no-print">x</th>
</tr>
<tr><th>From</th><th>To</th></tr>
</thead>
<tbody id="billBody"></tbody>
</table>

<div>
<button onclick="addItem()" class="no-print">+ Add Coaching</button>
<button id="printBtn" onclick="window.print()" class="no-print" style="display:none;">üñ®Ô∏è Print Invoice</button>
<button onclick="saveInvoice()" class="no-print">üíæ Save Invoice</button>
<button onclick="newInvoice()" class="no-print">üÜï New Invoice</button>
</div>

<div class="actions">
<div class="date-filters no-print">
From: <input type="date" id="fromDate">
To: <input type="date" id="toDate">
</div>
<div>
<button onclick="exportToExcel()" class="no-print">üìä Export Excel</button>
</div>
</div>

<div class="totals">
<div id="grandTotal">Total Amount: ‚Çπ0.00</div>
<div id="amountInWords">Total (in words): Zero Rupees Only</div>
<div>Amount Paid: ‚Çπ<input type="number" id="amountPaid" value="0" min="0" oninput="calculateTotal()" style="width: 100px;"></div>
<div id="dueBalance">Due Balance: ‚Çπ0.00</div>
</div>

<div class="qr">
<p style="font-weight:bold; color:green; text-align:left;">Scan the Below QR to Pay the Fee:</p>
<div id="qrCanvas"></div>
</div>
</div>
</div>

<div class="notes" style="margin-top: 30px; font-size: 9px;">
<p><strong>Note:</strong></p>
<ol style="padding-left: 20px;">
<li>This is a computer-generated invoice; signature is not required.</li>
<li>Fee once paid is not refundable.</li>
</ol>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>
<script>
const API_BASE = "https://invoice-and-bill.onrender.com"; // Replace with your API
const invoiceDateInput = document.getElementById("invoiceDateInput");
if(invoiceDateInput) invoiceDateInput.valueAsDate = new Date();

async function populateDropdowns() {
  const studentSelect = document.getElementById("studentSelect");
  const invoiceList = document.getElementById("invoiceList");

  // fetch students
  try {
    const resStudents = await fetch(`${API_BASE}/students`);
    const { students } = await resStudents.json();
    studentSelect.innerHTML = `<option value="">-- STUDENT NAME --</option>`;
    Object.keys(students || {}).sort().forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      studentSelect.appendChild(opt);
    });
  } catch(e){ console.error("Failed to fetch students:", e); }

  // fetch invoices
  try {
    const resInvoices = await fetch(`${API_BASE}/invoices`);
    const { invoices } = await resInvoices.json();
    invoiceList.innerHTML = "";
    Object.keys(invoices || {}).sort((a,b)=> (parseInt(b.replace("INV-","")) || 0) - (parseInt(a.replace("INV-",""))||0))
      .forEach(no => {
        const opt = document.createElement("option");
        opt.value = no;
        invoiceList.appendChild(opt);
      });
  } catch(e){ console.error("Failed to fetch invoices:", e); }
}

async function handleStudentChange() {
  const name = document.getElementById("studentSelect").value;
  if(!name) return;
  try {
    const res = await fetch(`${API_BASE}/students/${encodeURIComponent(name)}`);
    if(!res.ok) return;
    const student = await res.json();
    document.getElementById("studentName").value = student.name || "";
    document.getElementById("phone").value = student.phone || "";
    document.getElementById("email").value = student.email || "";
    document.getElementById("address").value = student.address || "";
    document.getElementById("studentClass").value = student.class || "Class 9";
  } catch(e){ console.error("Error loading student:", e); }
}

async function handleInvoiceInput() {
  const invoiceNo = document.getElementById("invoiceSelect").value;
  if(!invoiceNo) return;
  try {
    const res = await fetch(`${API_BASE}/invoices/${invoiceNo}`);
    if(!res.ok) { alert("Invoice not found"); return; }
    const invoice = await res.json();
    if(!invoice) return;

    document.getElementById("studentName").value = invoice.name || "";
    document.getElementById("phone").value = invoice.phone || "";
    document.getElementById("email").value = invoice.email || "";
    document.getElementById("address").value = invoice.address || "";
    document.getElementById("studentClass").value = invoice.class || "Class 9";
    document.getElementById("invoiceDateInput").value = invoice.date || "";
    document.getElementById("invoiceNo").textContent = invoice.invoiceNo;
    document.getElementById("amountPaid").value = invoice.amountPaid || 0;

    const billBody = document.getElementById("billBody");
    billBody.innerHTML = "";
    document.getElementById("invoiceTable").style.display="table";

    (invoice.items||[]).forEach(item=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="date" class="fromDate" value="${item.fromDate||''}"></td>
        <td><input type="date" class="toDate" value="${item.toDate||''}"></td>
        <td><input type="text" class="service" value="${item.service||''}"></td>
        <td><input type="text" class="subject" value="${item.subject||''}"></td>
        <td><input type="number" class="qty-input" value="${item.qty||1}" oninput="calculateTotal()"></td>
        <td><input type="number" class="rate-input" value="${item.rate||0}" oninput="calculateTotal()"></td>
        <td><input type="text" class="total-input" value="${item.total||0}" readonly></td>
        <td class="no-print"><button class="delete-btn" onclick="deleteRow(this)">x</button></td>`;
      billBody.appendChild(tr);
    });
    calculateTotal();
  } catch(e){ console.error(e); alert("Failed to load invoice"); }
}

function addItem() {
  document.getElementById("invoiceTable").style.display="table";
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="date" class="fromDate"></td>
    <td><input type="date" class="toDate"></td>
    <td><input type="text" class="service" placeholder="Service Type"></td>
    <td><input type="text" class="subject" placeholder="Subject"></td>
    <td><input type="number" class="qty-input" value="1" oninput="calculateTotal()"></td>
    <td><input type="number" class="rate-input" value="0" oninput="calculateTotal()"></td>
    <td><input type="text" class="total-input" readonly></td>
    <td class="no-print"><button class="delete-btn" onclick="deleteRow(this)">x</button></td>`;
  document.getElementById("billBody").appendChild(tr);
  calculateTotal();
}

function deleteRow(btn){
  btn.closest("tr").remove();
  calculateTotal();
}

function calculateTotal() {
  let total = 0;
  document.querySelectorAll("#billBody tr").forEach(row=>{
    const qty = parseFloat(row.querySelector(".qty-input").value)||0;
    const rate = parseFloat(row.querySelector(".rate-input").value)||0;
    const rowTotal = qty * rate;
    row.querySelector(".total-input").value = rowTotal.toFixed(2);
    total += rowTotal;
  });
  document.getElementById("grandTotal").textContent = `Total Amount: ‚Çπ${total.toFixed(2)}`;
  document.getElementById("dueBalance").textContent = `Due Balance: ‚Çπ${(total - (parseFloat(document.getElementById("amountPaid").value)||0)).toFixed(2)}`;
  document.getElementById("amountInWords").textContent = `Total (in words): ${numberToWords(total)} Only`;
}

function numberToWords(amount) {
  if(amount === 0) return "Zero Rupees";
  const words = ["Zero","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"];
  const tens = ["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"];
  let num = Math.floor(amount), str = "";
  if(num>=1000){ str += words[Math.floor(num/1000)]+" Thousand "; num=num%1000; }
  if(num>=100){ str += words[Math.floor(num/100)]+" Hundred "; num=num%100; }
  if(num>=20){ str += tens[Math.floor(num/10)]+" "; num=num%10; }
  if(num>0) str += words[num]+" ";
  return str + "Rupees";
}

function newInvoice(){
  document.getElementById("invoiceNo").textContent = `INV-${Date.now()}`;
  document.getElementById("invoiceDateInput").valueAsDate = new Date();
  document.getElementById("studentSelect").value="";
  document.getElementById("invoiceSelect").value="";
  ["studentName","phone","email","address","amountPaid"].forEach(id=>document.getElementById(id).value="");
  document.getElementById("billBody").innerHTML="";
  document.getElementById("invoiceTable").style.display="none";
  document.getElementById("printBtn").style.display="none";
  calculateTotal();
}

async function saveInvoice() {
  const invoice = {
    invoiceNo: document.getElementById("invoiceNo").textContent,
    date: document.getElementById("invoiceDateInput").value,
    name: document.getElementById("studentName").value,
    phone: document.getElementById("phone").value,
    email: document.getElementById("email").value,
    address: document.getElementById("address").value,
    class: document.getElementById("studentClass").value,
    amountPaid: parseFloat(document.getElementById("amountPaid").value)||0,
    items: []
  };
  document.querySelectorAll("#billBody tr").forEach(row=>{
    invoice.items.push({
      fromDate: row.querySelector(".fromDate").value,
      toDate: row.querySelector(".toDate").value,
      service: row.querySelector(".service").value,
      subject: row.querySelector(".subject").value,
      qty: parseFloat(row.querySelector(".qty-input").value)||0,
      rate: parseFloat(row.querySelector(".rate-input").value)||0,
      total: parseFloat(row.querySelector(".total-input").value)||0
    });
  });
  try{
    const res = await fetch(`${API_BASE}/saveInvoice`, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(invoice)});
    if(res.ok) { alert("Invoice saved successfully!"); document.getElementById("printBtn").style.display="inline-block"; }
    else alert("Failed to save invoice");
  } catch(e){ console.error(e); alert("Error saving invoice"); }
}

function exportToExcel() {
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(document.getElementById("invoiceTable"));
  XLSX.utils.book_append_sheet(wb, ws, "Invoice");
  XLSX.writeFile(wb, `${document.getElementById("invoiceNo").textContent}.xlsx`);
}

// Password protection
function checkPassword() {
  if(document.getElementById("passwordInput").value==="7099050509") {
    document.getElementById("passwordScreen").style.display="none";
    document.getElementById("protectedContent").style.display="block";
    populateDropdowns();
    newInvoice();
  } else alert("Wrong password!");
}
</script>
</body>
</html>
